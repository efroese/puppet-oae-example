# file managed by puppet
# This is the Sakai OAE trusted content virtual host

SSLCryptoDevice builtin

<VirtualHost<% sslports.each do |port| -%> <%= port %><% end -%>>
    ServerName <%= name %>

<% aliases.each do |serveralias| -%>
    ServerAlias <%= serveralias %>
<% end -%>

    DocumentRoot <%= documentroot %>

    LogLevel warn
    ErrorLog <%= wwwroot %>/<%= name %>/logs/error.log
    CustomLog <%= wwwroot %>/<%= name %>/logs/access.log combined
    TransferLog <%= wwwroot %>/<%= name %>/logs/transfer.log

    SSLEngine On
    SSLCipherSuite HIGH:MEDIUM
    SSLProtocol all -SSLv2
    SSLCertificateFile <%= certfile %>
    SSLCertificateKeyFile <%= certkeyfile %>
    SSLCACertificateFile <%= cacertfile %>
    
    # Force all clients to SSL port (trusted)
    RewriteEngine on
    RewriteCond %{HTTP_HOST} != <%= name %>
    RewriteRule (.*) https://<%= name %>%{REQUEST_URI} [R,L]

    Include <%= wwwroot %>/<%= name%>/conf/*.conf

<% if has_variable?("certchainfile") -%>
    SSLCertificateChainFile <%= certchainfile %>
<% end -%>

    # Enable Persistent Connections
    # http://httpd.apache.org/docs/2.2/mod/core.html#keepalive
    KeepAlive On

    # do not turn on == evil (i.e. open proxy)
    ProxyRequests Off
    # Turn off VIA header as we know where the requests are proxied
    ProxyVia Off
    # see http://docs.codehaus.org/display/JETTY/Configuring+mod_proxy
    ProxyPreserveHost On
    
    # restrict access to system console
    <Location /system/console>
        Order deny,allow
        deny from all
        <% scope.lookupvar('localconfig::oae_admin_hosts').each do |admin_host| -%>
        allow from <%= admin_host %>
        <% end -%>
    </Location>

    # restrict access to balancer-manager
    <Location /balancer-manager>
        SetHandler balancer-manager

        Order deny,allow
        deny from all
        <% scope.lookupvar('localconfig::oae_admin_hosts').each do |admin_host| -%>
        allow from <%= admin_host %>
        <% end -%>
    </Location>

    # /dav goes to the utility server
    # ignore |sakai-axis.* for now to work around LTI webservices.allow=.+ issue
    <LocationMatch "^/(dav.*)">
        ProxyPassMatch ajp://<%= scope.lookupvar('localconfig::cle_dav_server0') %>/$1
    </LocationMatch>

    <% if scope.lookupvar('localconfig::disable_cle_axis') -%>
    #  deny /sakai-axis
    <LocationMatch "^/(sakai-axis.*)">
        Redirect gone /
    </LocationMatch>
    <% end -%>

    ErrorDocument 503 http://feynman.rsmart.com/downtime.html
    ServerSignature Off

</VirtualHost>