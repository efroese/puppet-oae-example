MAILTO=""

DEBUG_OUT=false;

CLE_PROC_DIR=<%= scope.lookupvar('oipp::sis::cle_csv') %>
OAE_PROC_DIR=<%= scope.lookupvar('oipp::sis::oae_csv') %>
LOG=<%= scope.lookupvar('oipp::sis::sis_log') %>
ARCHIVE_ROOT=<%= scope.lookupvar('oipp::sis::sis_error_archive') %>
ARCHIVE_DIR=$ARCHIVE_DIR/`date +%Y%m%d-%H%M`;
REMOTE=<%= scope.lookupvar('oipp::sis::use_scp') %>
PRODUCTION=<%= scope.lookupvar('oipp::sis::production') %>;

log()
{
    LOG_LEVEL=$1;
    LOG_MESSAGE=$2;
    DATE_STR=`date +"%m/%d/%Y %H:%M:%S"`;

    echo "$DATE_STR [$LOG_LEVEL]: $LOG_MESSAGE" >> $LOG;
}

debug()
{
    if $DEBUG_OUT ; then
        log "DEBUG" "$1";
    fi;
}

error()
{
    log "ERROR" "$1";
}

info()
{
    log "INFO" "$1";
}

archive()
{
    SOURCES=$1;

    if [ ! -e "$ARCHIVE_DIR" ] ; then
        mkdir -p "$ARCHIVE_DIR";
    fi

    if [ ! -w "$ARCHIVE_DIR" ] ; then
        error "Cannot write to archive directory: $ARCHIVE_DIR";
        return 1;
    fi

    if [ ! -d "$ARCHIVE_DIR" ] ; then
        error "Cannot archive. $ARCHIVE_DIR is not a directory";
    fi

    mv $SOURCES $ARCHIVE_DIR;
}

transferSISFiles()
{
    SOURCE_FILES=$1;
    DEST_DIR=$2;

    if [ -z $3 ] ; then
        CP=cp;
    else
        CP=$3;
    fi;

    debug "transferring $SOURCE_FILES to $DEST_DIR";

    # copy files
    $CP $SOURCE_FILES $DEST_DIR;
}

doAllTransfers ()
{
    SOURCE_DIR=$1;
    ABBREV=$2;
    CP=$3;
    PROD_FILES=$SOURCE_DIR/*.$ABBREV.csv;
    TEST_FILES=$SOURCE_DIR/test/*;
    ERRORS=false;

    debug "SOURCE_DIR=$SOURCE_DIR";
    debug "ABBREV=$ABBREV";

    ls $PROD_FILES >> /dev/null;

    if [ $? -eq 0 ] ; then

        if $PRODUCTION; then
            oipptest="rsmart@oipp-test:~/sistest";
            info "copying $ABBREV files to OIPP test";
            transferSISFiles "$PROD_FILES" "$oipptest" scp;
            if [ $? -ne 0 ] ; then
                ERRORS=true;
                error "Failed to copy $PROD_FILES to $oipptest";
            fi;
        fi;

        info "copying $ABBREV files to CLE test";
        transferSISFiles "$PROD_FILES" "$CLE_PROC_DIR/test" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy $PROD_FILES to $CLE_PROC_DIR/test";
        fi;

        info "copying $ABBREV files to CLE";
        transferSISFiles "$PROD_FILES" "$CLE_PROC_DIR" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy $PROD_FILES to $CLE_PROC_DIR";
        fi;

        info "copying $ABBREV files to OAE";
        transferSISFiles "$PROD_FILES" "$OAE_PROC_DIR" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy $PROD_FILES to $OAE_PROC_DIR/test";
        fi;

        if ! $ERRORS ; then
            info "production files successfully copied"
            rm -f $PROD_FILES;
        else
            archive $PROD_FILES;
            error "Errors occured during file transfer; Import files have been copied to $ARCHIVE_DIR";
        fi;
    fi;

    if [ -e $TEST_FILES ] ; then
        ERRORS=false;

        info "Copying test files to CLE test";
        transferSISFiles "$TEST_FILES" "$CLE_PROC_DIR/test" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy $TEST_FILES to $CLE_PROC_DIR/test";
        fi;

        if $PRODUCTION ; then
            oipptest="rsmart@oipp-test:~/sistest/test/";
            info "copying test files to OIPP test";
            transferSISFiles "$TEST_FILES" "$oipptest" scp;
            if [ $? -ne 0 ] ; then
                ERRORS=true;
                error "Failed to copy $TEST_FILES to $oipptest";
            fi;
        fi;

        if $ERRORS ; then
            archive "$TEST_FILES";
            error "Errors occured transfering test files; Test import files have been copied to $ERROR_ARCHIVE";
        else
            info "test files successfully copied";
            rm -f "$TEST_FILES";
        fi;

    fi;
}

info "Started SIS file transfer";

if $REMOTE ; then
    CP=scp;
else
    CP=cp;
fi;

<% csv_schools.each do |school| -%>
doAllTransfers "<%= school[0] %>" "<%= school[1] %>" $CP;
<% end -%>

info "SIS file transfers complete";