MAILTO=""

DEBUG_OUT=<%= scope.lookupvar('oipp::sis::debug') %>;

LOG=<%= scope.lookupvar('oipp::sis::sis_log') %>
ARCHIVE_ROOT=<%= scope.lookupvar('oipp::sis::sis_error_archive') %>
ARCHIVE_DIR=$ARCHIVE_ROOT/`date +%Y%m%d-%H%M`;
REMOTE=<%= scope.lookupvar('oipp::sis::use_scp') %>

log()
{
    LOG_LEVEL=$1;
    LOG_MESSAGE=$2;
    DATE_STR=`date +"%m/%d/%Y %H:%M:%S"`;

    echo "$DATE_STR [$LOG_LEVEL]: $LOG_MESSAGE" >> $LOG;
}

debug()
{
    if $DEBUG_OUT ; then
        log "DEBUG" "$1";
    fi;
}

error()
{
    log "ERROR" "$1";
}

info()
{
    log "INFO" "$1";
}

archive()
{
    SOURCES=$1;

    if [ ! -e "$ARCHIVE_DIR" ] ; then
        mkdir -p "$ARCHIVE_DIR";
    fi

    if [ ! -w "$ARCHIVE_DIR" ] ; then
        error "Cannot write to archive directory: $ARCHIVE_DIR";
        return 1;
    fi

    if [ ! -d "$ARCHIVE_DIR" ] ; then
        error "Cannot archive. $ARCHIVE_DIR is not a directory";
    fi

    mv $SOURCES $ARCHIVE_DIR;
}

transferSISFiles()
{
    SOURCE_FILES=$1;
    DEST_DIR=$2;

    if [ -z $3 ] ; then
        CP=cp;
    else
        CP=$3;
    fi;

    debug "transferring $SOURCE_FILES to $DEST_DIR";

    # copy files
    $CP $SOURCE_FILES $DEST_DIR;
}

doAllTransfers ()
{
    CP=$1;

    ##########################################
    # preform transfer of all production files
    ERRORS=false;

<% scope.lookupvar('oipp::sis::batch_school_properties').each do |school,props| -%>
    ## Transfers for <%= school %>

    <% scope.lookupvar('oipp::sis::transfer_definitions').each do |destination, files| -%>
        FILES="<% files.each do |file| -%><%= props['upload_dir'] %>/<%=file%>.<%=school%>.csv <% end %>";

        info "copying \"$FILES\" to <%= destination %> for <%=school%>";
        transferSISFiles "$FILES" "<%= destination %>" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy \"$FILES\" to <%= destination %> for <%=school%>";
        fi;

    <% end %>
        if $ERRORS ; then
            archive "$FILES";
            error "Errors occured transfering files for <%= school %>; Import files have been copied to $ERROR_ARCHIVE";
        else
            info "<%= school %> files successfully copied";
            rm -f "$FILES";
        fi;
<% end %>

    ##########################################
    # preform transfer of all test files
    ERRORS=false;

<% scope.lookupvar('oipp::sis::batch_school_properties').each do |school,props| -%>
    ## Transfers for <%= school %>

    <% scope.lookupvar('oipp::sis::transfer_test_definitions').each do |destination, files| -%>
        FILES="<% files.each do |file| -%><%= props['test_upload_dir'] %>/<%=file%>.<%=school%>.csv <% end %>";

        info "copying \"$FILES\" to <%= destination %> for <%=school%>";
        transferSISFiles "$FILES" "<%= destination %>" $CP;
        if [ $? -ne 0 ] ; then
            ERRORS=true;
            error "Failed to copy \"$FILES\" to <%= destination %> for <%=school%>";
        fi;

    <% end %>
        if $ERRORS ; then
            archive "$FILES";
            error "Errors occured transfering test files for <%= school %>; Test files have been copied to $ERROR_ARCHIVE";
        else
            info "<%= school %> files successfully copied";
            rm -f "$FILES";
        fi;
<% end %>

}

info "Started SIS file transfer";

if $REMOTE ; then
    CP=scp;
else
    CP=cp;
fi;

doAllTransfers $CP;

info "SIS file transfers complete";