
# file managed by puppet
<VirtualHost<% sslports.each do |port| -%> <%= port %><% end -%>>
  ServerName <%= name %>

<% aliases.each do |serveralias| -%>
    ServerAlias <%= serveralias %>
<% end -%>

    DocumentRoot <%= documentroot %>

    LogLevel warn

    ErrorLog <%= wwwroot %>/<%= name %>/logs/error.log
    CustomLog <%= wwwroot %>/<%= name %>/logs/access.log combined
    TransferLog <%= wwwroot %>/<%= name %>/logs/transfer.log

    Include <%= wwwroot %>/<%= name%>/conf/*.conf

    SSLEngine On
    SSLCipherSuite HIGH:MEDIUM
    SSLProtocol all -SSLv2

    SSLCertificateFile <%= certfile %>
    SSLCertificateKeyFile <%= certkeyfile %>
    SSLCACertificateFile <%= cacertfile %>

<% if has_variable?("certchainfile") -%>
    SSLCertificateChainFile <%= certchainfile %>
<% end -%>

    # do not turn on == evil (i.e. open proxy)
    ProxyRequests Off
    # Turn off VIA header as we know where the requests are proxied
    ProxyVia Off
    # see http://docs.codehaus.org/display/JETTY/Configuring+mod_proxy
    ProxyPreserveHost On
    
    # restrict access to system console
    <Location /system/console>
        Order deny,allow
        deny from all
        allow from 72.44.192.164
    </Location>
    
    # /dav and /sakai-axis go to utility server
    # ignore |sakai-axis.* for now to work around LTI webservices.allow=.+ issue
    <LocationMatch "^/(dav.*)">
        ProxyPassMatch ajp://10.53.10.19/$1
    </LocationMatch>
    
    <Proxy balancer://sakai_cle>
        BalancerMember ajp://10.53.10.17:8009 timeout=300 loadfactor=100 route=cle1
        BalancerMember ajp://10.53.10.17:8010 timeout=300 loadfactor=100 route=cle2
    </Proxy>

    # All of the required Sakai 2 URLs
    <LocationMatch "^/(xsl-portal.*|access.*|courier.*|dav.*|direct.*|imsblti.*|library.*|messageforums-tool.*|osp-common-tool.*|polls-tool.*|portal.*|profile-tool.*|profile2-tool.*|sakai.*|samigo-app.*|scheduler-tool.*|rsmart-customizer-tool.*|oauth-tool.*|emailtemplateservice-tool.*|sitestats-tool.*|rsmart-support-tool.*|mailsender-tool.*|tool.css|portool_base.css)">
        ProxyPassMatch balancer://sakai_cle/$1 nofailover=On stickysession=SAKAI2SESSIONID lbmethod=byrequests
        ProxyPassReverse balancer://sakai_cle/

        SetOutputFilter DEFLATE
        # Netscape 4.x has some problems...
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        # Netscape 4.06-4.08 have some more problems
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        # MSIE masquerades as Netscape, but it is fine
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        # Don't compress images
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        # Make sure proxies don't deliver the wrong content
        Header append Vary User-Agent env=!dont-vary
    </LocationMatch>

    ErrorDocument 503 http://feynman.rsmart.com/downtime.html
    ServerSignature Off

</VirtualHost>