#!/bin/bash

#
# run_sis_batch.sh
# - Run the rSmart basic SIS batch job
# 
# Erik Froese <erik@hallwaytech.com>
#

SIS_BATCH_HOME=<%= scope.lookupvar('sis::batch::home') %>
SIS_JAR=${SIS_BATCH_HOME}/<%= scope.lookupvar('sis::batch::artifact') %>
EMAIL_RECIPIENT="<%= scope.lookupvar('sis::batch::email_report') %>"

CSV_DIR=<%= scope.lookupvar('sis::batch::csv_dir') %>

JAVA_OPTS=" -Doae.server.url=<%= scope.lookupvar('sis::batch::server_url') %> "
JAVA_OPTS=" ${JAVA_OPTS} -Doae.admin.user=<%= scope.lookupvar('sis::batch::oae_user') %> "
JAVA_OPTS=" ${JAVA_OPTS} -Doae.admin.password=<%= scope.lookupvar('sis::batch::oae_password') %> "

<% if scope.lookupvar('sis::batch::sis_properties') -%>
JAVA_OPTS="${JAVA_OPTS} -Dsis.config.file=${SIS_BATCH_HOME}/sis.properties "
<% end -%>

CSV_ARCHIVE=${CSV_DIR}/`date +%Y%m%d-%H%M`
mkdir -p ${CSV_ARCHIVE}

OUTPUT=`mktemp`

# Files will be of the form name.school.csv
SCHOOL_USERS = "<%=scope.lookupvar('sis::batch::sis_users') %>"
#SCHOOLS = `ls ${CSV_DIR} | awk -F . '{ print $2 }' | sort | uniq`

for schooluser in $SCHOOL_USERS; do
    FILENAME_OPTS="";
    for file in Course Membership User Section SectionMembership; do
        CSV_FILE="/home/${schooluser}/${file}.${school}.csv"
        if [[ -f ${CSV_FILE} ]]; then
            FILENAME_OPTS="${FILENAME_OPTS} -Dfilename@com.rsmart.customer.integration.processor.cle.Cle${file}Processor=${CSV_FILE}" 
        else
            echo "No file for ${CSV_FILE}" >> $OUTPUT
        fi
    done
    java ${JAVA_OPTS} ${FILENAME_OPTS} \
        -jar $SIS_JAR 2>&1 >> $OUTPUT
    for file in Course Membership User Section SectionMembership; do
        CSV_FILE="/home/${schooluser}/${file}.${school}.csv"
        mv ${CSV_FILE} ${CSV_ARCHIVE}
    done
done

if [[ $EMAIL_RECIPIENT != "undefined" ]]; then
    mail -s "SIS batch update for $NOW" $EMAIL_RECIPIENT < $OUTPUT
fi
rm -f $OUTPUT
